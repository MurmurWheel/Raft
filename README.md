# raft

C++ 实现 Raft 共识算法

## 一、Raft

### 1.1 架构

我们的 Raft 实现由 MessageQueue + 主线程 + 线程池 + 定时器四个部分组成：

- **主线程** 更新节点状态
- **MessageQueue** 线程池和主线程之间通信
- **线程池** 用于处理耗时的 IO 流程
- **定时器** 实现心跳，选举中的定时回调功能

### 1.2 选主流程

选主的流程：

![flow](/images/flow.png)


### 1.3 用户命令执行流程

流程如下：

1. leader 收到用户请求后启动一个新线程执行日志复制命令
3. 当大多数节点已将日志写入磁盘后，向消息队列发送一个 op 指令
4. leader 执行操作
5. leader 启动一个线程将操作的结果返回

### 1.4 集群配置变更流程

## 二、RPC

### 2.1 数据格式

请求：

```json
{
    "op":"OP",
    "params":{
        ...
    }
}
```

- **op** 操作类型，必须是 string 类型
- **params** 参数，必须是 object 类型

响应：

```json
{
    ...
}
```

- 响应是一个 json 对象，其中包含具体的数据，即便没有任何数据需要被返回，也必须返回一个 `{}` 对象。

### 2.2 节点内部指令

- **timeout** 选举超时
- **rollback** 回滚
- **commit** 提交

### 2.3 节点间指令

- **vote** 选举
- **heart** 心跳
- **log** 日志复制
- **append** 一致性检查

### 2.4 用户指令

- **echo** 打印进程 id
- **get** 设置某个 key
- **set** 获取某个 key


### 2.4 不同类型的节点再收到用户命令时的行为

- **follower**
  - **vote** 更新 **term**，重设选举超时时间
  - **heart** 更新 **term**，重设选举超时时间
  - **log** 复制日志
- **candidate**
  - **heart** 更新 **term**
  - **vote** 选举
- **leader**
   - **user** 处理用户命令


## 三、其他

### **1.处理网络异常**

- 超时
- connection refused

### **2.长连接？短连接？**

为了降低实现的难度，在实现 Raft 算法的过程中，我们使用短连接，即在会话结束后，就立即销毁连接。
